<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ Mood & Habit Butler üå∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        :root {
            --main-pink: #ff85a1; --light-pink: #fff0f3; --soft-bg: #fdf2f5; --deep-pink: #ff4d7d;
            --analysis-bg: linear-gradient(135deg, #ff9a9e 0%, #ff85a1 100%);
        }
        [data-theme="ocean"] {
            --main-pink: #48cae4; --light-pink: #e0f7fa; --soft-bg: #f0faff; --deep-pink: #0077b6;
            --analysis-bg: linear-gradient(135deg, #00b4d8 0%, #90e0ef 100%);
        }
        [data-theme="forest"] {
            --main-pink: #81b29a; --light-pink: #f2f4f3; --soft-bg: #f8f9f8; --deep-pink: #3d405b;
            --analysis-bg: linear-gradient(135deg, #81b29a 0%, #a8dadc 100%);
        }

        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--soft-bg); margin: 0; padding: 20px; display: flex; justify-content: center; color: #444; transition: all 0.3s; }
        .container { max-width: 1200px; width: 100%; display: grid; grid-template-columns: 360px 1fr; gap: 20px; }
        .card { background: #fff; border-radius: 25px; padding: 22px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); margin-bottom: 20px; position: relative; border: 1px solid rgba(0,0,0,0.02); }

        .graph-title-bar { background: white; border-radius: 20px; padding: 15px 25px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .title-group { display: flex; align-items: center; gap: 15px; }
        .title-group h2 { font-family: 'Dancing Script', cursive; font-size: 2.2rem; color: var(--deep-pink); margin: 0; }
        
        #themeMenuPopup { display: none; position: absolute; top: 45px; left: 100%; transform: translateX(10px); background: white; padding: 12px; border-radius: 18px; border: 2px solid var(--main-pink); z-index: 2000; flex-direction: column; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .theme-opt { padding: 6px 12px; border-radius: 10px; cursor: pointer; font-size: 0.85rem; font-weight: bold; white-space: nowrap; }
        .theme-opt:hover { background: var(--light-pink); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-label { font-size: 0.75rem; font-weight: 700; color: var(--main-pink); text-align: center; margin-bottom: 8px; }
        .day-cell { aspect-ratio: 1.1; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; font-size: 0.9rem; border: 1px solid var(--light-pink); position: relative; z-index: 1; background: #fff; }
        .day-cell.active { border: 2px solid var(--main-pink); font-weight: 700; color: var(--deep-pink); }
        .day-cell.recorded::after { content: '‚ù§Ô∏è'; position: absolute; font-size: 1.8rem; opacity: 0.2; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1; }

        .mood-btn { font-size: 1.8rem; border: none; background: none; cursor: pointer; border-radius: 10px; }
        .mood-btn.picking { background: var(--light-pink); outline: 2px solid var(--main-pink); }

        #emojiMenu { display: none; position: absolute; right: 20px; top: 50px; background: white; border: 2px solid var(--main-pink); border-radius: 20px; padding: 15px; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 300px; }
        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 250px; overflow-y: auto; }

        .habit-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .habit-name { border: none; border-bottom: 1px dashed var(--main-pink); font-size: 0.95rem; width: 100%; outline: none; background: transparent; font-family: inherit; }
        
        .analysis-box { background: var(--analysis-bg); color: #fff; border-radius: 25px; padding: 25px; min-height: 150px; font-size: 1.05rem; line-height: 1.7; transition: 0.3s; }
        
        .input-field { width: 100%; border: 1px solid var(--light-pink); border-radius: 15px; padding: 12px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; outline: none; }
        .btn-pink { background: var(--main-pink); color: white; border: none; padding: 12px; border-radius: 15px; cursor: pointer; width: 100%; font-weight: 700; font-family: inherit; }
        .view-btn-large { flex: 1; padding: 12px; border-radius: 15px; border: 2.5px solid var(--main-pink); background: white; color: var(--main-pink); font-weight: 700; cursor: pointer; font-family: inherit; }
        .view-btn-large.active { background: var(--main-pink); color: white; }

        #cloud-tooltip { position: fixed; display: none; background: #fff; border: 2px solid var(--main-pink); padding: 12px 18px; border-radius: 25px; z-index: 3000; pointer-events: none; font-size: 0.9rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); color: #444; font-weight: 500; max-width: 200px; white-space: normal; transform: translate(-50%, -110%); }
        #cloud-tooltip::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); border-width: 10px 10px 0; border-style: solid; border-color: var(--main-pink) transparent; }

        #yearly-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--soft-bg); z-index: 9999; overflow-y: auto; padding: 40px; box-sizing: border-box; }
        .month-row { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; position: relative; }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                <button onclick="changeMonth(-1)" style="background:none; border:none; color:var(--main-pink); cursor:pointer;">‚óÄ</button>
                <h3 id="monthDisplay" style="margin:0; color:var(--deep-pink);"></h3>
                <button onclick="changeMonth(1)" style="background:none; border:none; color:var(--main-pink); cursor:pointer;">‚ñ∂</button>
            </div>
            <div class="calendar-grid" id="calendar"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="mood-box" id="moodBtnBox"></div>
                <div style="font-size:1.2rem; color:#ddd; cursor:pointer;" onclick="toggleEmojiMenu()">‚ãÆ</div>
                <div id="emojiMenu">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>
            </div>
            <textarea id="noteInput" class="input-field" style="height: 80px; resize: none;" placeholder="Ïò§Îäò Ïñ¥Îñ§ ÏùºÏù¥ ÏûàÏóàÎÇòÏöî?"></textarea>
            <input type="text" id="affirmationInput" class="input-field" placeholder="ÎÇòÎ•º Ìñ•Ìïú ÌïúÎßàÎîî ‚ú®">
            <div style="display:flex; gap:10px;">
                <button class="btn-pink" onclick="saveAll()">Í∏∞Î°ù ÏôÑÎ£å ‚ú®</button>
                <button style="background:none; border:none; font-size:1.4rem; cursor:pointer;" onclick="confirmDelete()">üóëÔ∏è</button>
            </div>
        </div>

        <div class="card" id="habitCard">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:18px;">
                <h3 style="margin:0; color:var(--deep-pink); font-weight:800;">Habit Tracker</h3>
                <div style="display:flex; gap:12px; align-items: center;">
                    <span style="cursor:pointer; font-size:1.1rem;" onclick="toggleEditHabit()" id="editToggleBtn">‚öôÔ∏è</span>
                    <span style="cursor:pointer; font-size:1.3rem;" onclick="toggleHabitChart()">üìà</span>
                    <span style="cursor:pointer; font-size:1.3rem;" onclick="toggleHabitAnalysis()">üîç</span>
                </div>
            </div>
            <div id="habitList"></div>
            <div id="addHabitBtn" onclick="addHabitItem()" style="display:none; text-align:center; color:var(--main-pink); cursor:pointer; border:1.5px dashed var(--main-pink); border-radius:12px; padding:8px; margin-top:10px; font-weight:bold;">+ ÏÉàÎ°úÏö¥ Î™©Ìëú Ï∂îÍ∞Ä</div>
        </div>
    </div>

    <div class="main-content">
        <div class="graph-title-bar">
            <div class="title-group">
                <h2>Your Mood Butler</h2>
                <div style="position:relative;">
                    <button onclick="toggleThemeMenu()" style="background:none; border:none; cursor:pointer; font-size:1.4rem;">üé®</button>
                    <div id="themeMenuPopup">
                        <div class="theme-opt" onclick="applyTheme('pink')">üå∏ Original Pink</div>
                        <div class="theme-opt" onclick="applyTheme('ocean')">üåä Ocean Calm</div>
                        <div class="theme-opt" onclick="applyTheme('forest')">üåø Deep Forest</div>
                        <div style="border-top:1px solid #eee; margin:5px 0;"></div>
                        <div style="font-size:0.75rem; color:#999; margin-left:12px;">Custom Color</div>
                        <input type="color" onchange="applyCustomTheme(this.value)" style="width:100%; height:30px; border:none; cursor:pointer; background:none;">
                    </div>
                </div>
            </div>
            <button class="view-btn-large" style="flex:none; width:180px; font-family:'Dancing Script';" onclick="openYearlyView()">Yearly Journey</button>
        </div>

        <div class="card">
            <div style="display:flex; gap:10px; margin-bottom: 20px;">
                <button id="btn-monthly" class="view-btn-large active" onclick="switchView('monthly')">Monthly</button>
                <button id="btn-weekly" class="view-btn-large" onclick="switchView('weekly')">Weekly</button>
            </div>
            <div style="height:380px;">
                <canvas id="moodChart"></canvas>
            </div>
            <div id="affirmationDisplay" style="margin-top:20px; min-height:30px; text-align:center; color:var(--main-pink); font-style:italic; font-weight:600;"></div>
        </div>

        <div class="card analysis-box" id="analysisBox">
            <h4 style="margin:0 0 10px 0; opacity:0.9;">ü™Ñ AI Butler's Insight</h4>
            <div id="moodAnalysisText">Î∂ÑÏÑù Ï§ë...</div>
            <div id="habitAnalysisText" style="margin-top:10px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.3); display:none;"></div>
        </div>
    </div>
</div>

<div id="yearly-overlay">
    <div style="max-width: 900px; margin: 0 auto;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:30px;">
            <h1 style="font-family:'Dancing Script'; color:var(--deep-pink); font-size:3.5rem; margin:0;">2026 Journey</h1>
            <button onclick="closeYearlyView()" class="btn-pink" style="width:100px;">Îã´Í∏∞</button>
        </div>
        <div id="yearlyList"></div>
    </div>
</div>

<div id="cloud-tooltip"></div>

<script>
    let currentView = 'monthly', dateContext = new Date();
    let selectedDateKey = formatDate(new Date());
    let pickingIndex = -1;
    let isEditMode = false;
    let isHabitAnalysisOpen = false; // üîç Î∂ÑÏÑùÏ∞Ω ÏÉÅÌÉú Í¥ÄÎ¶¨ Î≥ÄÏàò

    const store = JSON.parse(localStorage.getItem('moodHabitData_vFinal_V7')) || {};
    let habitNames = JSON.parse(localStorage.getItem('moodHabit_HabitNames')) || ["Î¨º 2L ÎßàÏãúÍ∏∞", "Ïö¥Îèô 30Î∂Ñ", "ÎπÑÌÉÄÎØº Ï±ôÍ∏∞Í∏∞", "ÎèÖÏÑú 10Î∂Ñ"];
    let currentTheme = localStorage.getItem('moodHabit_Theme') || 'pink';
    let customColor = localStorage.getItem('moodHabit_CustomColor') || null;
    let emojiSet = JSON.parse(localStorage.getItem('moodHabit_EmojiSet')) || ["", "üò≠", "üòî", "üôÇ", "üòä", "üòÜ"];

    const allEmojis = ["üò≠","üòî","üôÇ","üòä","üòÜ","ü•∞","üòç","ü•≥","ü§©","üòé","ü•∫","ü§î","ü§®","üôÑ","üòè","üò§","üò†","üò°","ü§¨","ü§Ø","üò±","üò®","üò∞","üò•","üòì","ü§ó","ü§î","ü§≠","ü§´","ü§•","üò∂","üòê","üòë","üò¨","üôÑ","üòØ","üò¶","üòß","üòÆ","üò≤","ü•±","üò¥","ü§§","üò™","üòµ","ü§ê","ü•¥","ü§¢","ü§Æ","ü§ß","üò∑","ü§í","ü§ï","ü§ë","ü§†","üòà","üëø","üëπ","üë∫","ü§°","üí©","üëª","üíÄ","‚ò†Ô∏è","üëΩ","üëæ","ü§ñ","üéÉ","üò∫","üò∏","üòπ","üòª","üòº","üòΩ","üôÄ","üòø","üòæ","ü§≤","üëê","üôå","üëè","ü§ù","üëç","üëé","üëä","‚úä","ü§õ","ü§ú","ü§û","‚úåÔ∏è","ü§ü","ü§ò","üëå","üëà","üëâ","üëÜ","üëá","‚òùÔ∏è","‚úã","ü§ö","üñê","üññ","üëã","ü§ô","üí™","ü¶æ","üñï","‚úçÔ∏è","üôè","üíç","üíÑ","üíã","üëÑ","üëÖ","üëÇ","ü¶ª","üëÉ","üë£","üëÅÔ∏è","üëÄ","üß†","üó£Ô∏è","üë§","üë•","ü§±","ü§∞","ü§≥","üíÉ","üï∫","üëØ","üë´","üë≠","üë¨","üß∂","üßµ","üß•","ü•º","ü¶∫","üëö","üëï","üëñ","üß£","üß§","üß•","üß¶","üëó","üëò","üëô","üëí","üé©","üëü","üëû","üë¢","üë°","üë†","üëú","üëõ","üéí","üíº","üï∂Ô∏è","üåÇ","üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üêØ","ü¶Å","üêÆ","üê∑","üêΩ","üê∏","üêµ"];

    let mainChart;
    const ctx = document.getElementById('moodChart').getContext('2d');
    const cloudTooltip = document.getElementById('cloud-tooltip');
    const affirmationDisplay = document.getElementById('affirmationDisplay');

    function init() {
        if (customColor) applyCustomTheme(customColor, false);
        else applyTheme(currentTheme, false);

        renderCalendar();
        renderMoodButtons();
        renderEmojiPicker();
        renderHabitList();
        initChart();
        loadData();
    }

    function formatDate(date) { return `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`; }

    function runMoodAnalysisAuto() {
        const keys = mainChart.data.rawKeys;
        const viewName = currentView === 'monthly' ? "Ïù¥Î≤à Îã¨" : "Ïù¥Î≤à Ï£º";
        let moodSum = 0, moodCount = 0;
        keys.forEach(k => { if(store[k]?.mood) { moodSum += store[k].mood; moodCount++; } });

        let analysis = `<b>[${viewName} Í∏∞Î∂Ñ ÏöîÏïΩ]</b><br>`;
        if(moodCount > 0) {
            const avg = moodSum / moodCount;
            if(avg >= 4) analysis += `Îß§Ïö∞ ÌôúÍ∏∞Ï∞¨ ÎÇ†Îì§Ïù¥ÏóàÎÑ§Ïöî! ÏßÄÍ∏àÏ≤òÎüº Í∏çÏ†ïÏ†ÅÏù∏ ÏóêÎÑàÏßÄÎ•º Ïú†ÏßÄÌï¥Î¥êÏöî. ‚ú®`;
            else if(avg >= 2.5) analysis += `ÌèâÏò®ÌïòÍ≥† Í∑†Ìòï Ïû°Ìûå ÎßàÏùåÏù¥ ÎäêÍª¥ÏßëÎãàÎã§. Ï∞∏ ÏûòÌïòÍ≥† Í≥ÑÏÑ∏Ïöî. üåø`;
            else analysis += `Ï°∞Í∏à Í∞ÄÎùºÏïâÏùÄ ÎÇ†Îì§Ïù¥ ÏûàÏóàÏßÄÎßå, Í∑∏Îü∞ ÎÇ† ÎòêÌïú Í≥ºÏ†ïÏùº ÎøêÏûÖÎãàÎã§. ü´Ç`;
        } else { analysis += "ÏïÑÏßÅ Í∏∞Î°ùÎêú Í∏∞Î∂ÑÏù¥ ÏóÜÏäµÎãàÎã§."; }
        document.getElementById('moodAnalysisText').innerHTML = analysis;
        
        // ‚òÖ Ï§ëÏöî: Í∏∞Î∂Ñ Î∂ÑÏÑùÏù¥ Ïã§ÌñâÎê† Îïå ÏäµÍ¥Ä Î∂ÑÏÑùÏù¥ ÏºúÏ†∏ÏûàÎã§Î©¥ ÏäµÍ¥Ä Îç∞Ïù¥ÌÑ∞ÎèÑ Í∞±Ïã†
        if(isHabitAnalysisOpen) runHabitAnalysisOnly();
    }

    // üîç ÎèãÎ≥¥Í∏∞ ÌÜ†Í∏Ä Ìï®Ïàò
    function toggleHabitAnalysis() {
        isHabitAnalysisOpen = !isHabitAnalysisOpen;
        const hBox = document.getElementById('habitAnalysisText');
        if(isHabitAnalysisOpen) {
            hBox.style.display = 'block';
            runHabitAnalysisOnly();
        } else {
            hBox.style.display = 'none';
        }
    }

    function runHabitAnalysisOnly() {
        const keys = mainChart.data.rawKeys;
        const viewName = currentView === 'monthly' ? "Ïù¥Î≤à Îã¨" : "Ïù¥Î≤à Ï£º";
        let habitCounts = habitNames.map(() => 0);
        let activeDays = 0;

        keys.forEach(k => {
            if(store[k]?.habits && store[k].habits.some(h => h === true)) {
                activeDays++;
                store[k].habits.forEach((h, idx) => { if(h) habitCounts[idx]++; });
            }
        });

        const hBox = document.getElementById('habitAnalysisText');
        if(activeDays > 0) {
            let maxVal = Math.max(...habitCounts);
            let minVal = Math.min(...habitCounts);
            let bestIdx = habitCounts.indexOf(maxVal);
            let worstIdx = habitCounts.indexOf(minVal);

            let text = `<b>[${viewName} ÏäµÍ¥Ä Î∂ÑÏÑù]</b><br>`;
            text += `Í∏∞Î°ùÎêú <b>${activeDays}Ïùº</b> Ï§ë <b>'${habitNames[bestIdx]}'</b>ÏùÑ(Î•º) Í∞ÄÏû• Ïûò Ïã§Ï≤úÌïòÏÖ®ÎÑ§Ïöî! Ï†ïÎßê Ïπ≠Ï∞¨Ìï¥Ïöî. üëè`;
            if(maxVal !== minVal) { text += `<br><b>'${habitNames[worstIdx]}'</b>ÎèÑ Ìïú Î≤àÎßå Îçî ÏãúÎèÑÌï¥Î≥¥Î©¥ Ïñ¥Îñ®ÍπåÏöî? ÌûòÎÇ¥ÏÑ∏Ïöî!`; }
            hBox.innerHTML = text;
        } else { hBox.innerHTML = `<b>[${viewName} ÏäµÍ¥Ä Î∂ÑÏÑù]</b><br>ÏïÑÏßÅ Ïã§Ï≤úÎêú ÏäµÍ¥Ä Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.`; }
    }

    function initChart() {
        mainChart = new Chart(ctx, {
            data: {
                labels: [],
                datasets: [
                    { type: 'line', data: [], borderColor: getComputedStyle(document.documentElement).getPropertyValue('--main-pink'), borderWidth: 5, tension: 0.3, pointRadius: 7, pointBackgroundColor: '#fff', hoverPointRadius: 10, spanGaps: true },
                    { type: 'bar', data: [], backgroundColor: hexToRgba(getComputedStyle(document.documentElement).getPropertyValue('--main-pink'), 0.2), hidden: true, borderRadius: 5 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: {
                    y: { min: 0, max: 6, ticks: { font: { size: 22 }, callback: v => emojiSet[v] || '' } },
                    x: { grid: { display: false } }
                },
                onHover: (e, el) => {
                    if (el.length > 0) {
                        const index = el[0].index;
                        const key = mainChart.data.rawKeys[index];
                        const entry = store[key];
                        if(entry?.note) {
                            cloudTooltip.innerText = entry.note;
                            cloudTooltip.style.display = 'block';
                            cloudTooltip.style.left = e.native.clientX + 'px';
                            cloudTooltip.style.top = e.native.clientY + 'px';
                        } else { cloudTooltip.style.display = 'none'; }
                        if(entry?.affirmation) { affirmationDisplay.innerText = `"${entry.affirmation}"`; }
                        else { affirmationDisplay.innerText = ""; }
                        return;
                    }
                    cloudTooltip.style.display = 'none';
                    const currentEntry = store[selectedDateKey];
                    affirmationDisplay.innerText = currentEntry?.affirmation ? `"${currentEntry.affirmation}"` : "";
                }
            }
        });
        updateChartData();
    }

    function updateChartData() {
        const y = dateContext.getFullYear(), m = dateContext.getMonth() + 1;
        let labels = [], rawKeys = [];
        if (currentView === 'monthly') {
            const last = new Date(y, m, 0).getDate();
            for(let i=1; i<=last; i++) { labels.push(i); rawKeys.push(`${y}-${m}-${i}`); }
        } else {
            const sel = new Date(selectedDateKey); const sun = new Date(sel.setDate(sel.getDate() - sel.getDay()));
            for(let i=0; i<7; i++) { const d = new Date(sun); d.setDate(sun.getDate() + i); labels.push(d.getDate()); rawKeys.push(`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`); }
        }
        mainChart.data.labels = labels; mainChart.data.rawKeys = rawKeys;
        mainChart.data.datasets[0].data = rawKeys.map(k => store[k]?.mood || null);
        mainChart.data.datasets[1].data = rawKeys.map(k => (store[k]?.habits || []).filter(h => h).length);
        mainChart.update();
        runMoodAnalysisAuto(); // Ïù¥ ÎÇ¥Î∂ÄÏóêÏÑú ÏäµÍ¥Ä Î∂ÑÏÑùÎèÑ Ìï®Íªò Ìò∏Ï∂úÎê®
    }

    function triggerPinkConfetti() {
        const color = getComputedStyle(document.documentElement).getPropertyValue('--main-pink').trim();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: [color, '#ffb3c1', '#ffffff'] });
    }

    function renderMoodButtons() {
        const box = document.getElementById('moodBtnBox'); box.innerHTML = '';
        [5, 4, 3, 2, 1].forEach(v => {
            const btn = document.createElement('button'); btn.className = `mood-btn ${pickingIndex === v ? 'picking' : ''}`;
            btn.innerText = emojiSet[v];
            btn.onclick = () => {
                if (pickingIndex !== -1) return;
                if(!store[selectedDateKey]) store[selectedDateKey] = {mood:null, habits:[]};
                store[selectedDateKey].mood = v;
                if(v === 5) triggerPinkConfetti();
                saveToLocal(); updateChartData(); renderCalendar();
            };
            box.appendChild(btn);
        });
    }

    function saveToLocal() { 
        localStorage.setItem('moodHabitData_vFinal_V7', JSON.stringify(store)); 
        localStorage.setItem('moodHabit_HabitNames', JSON.stringify(habitNames));
        localStorage.setItem('moodHabit_EmojiSet', JSON.stringify(emojiSet));
    }

    function applyTheme(t, shouldClose = true) {
        document.documentElement.style = ""; document.documentElement.removeAttribute('data-theme');
        if(t !== 'pink') document.documentElement.setAttribute('data-theme', t);
        currentTheme = t; customColor = null;
        localStorage.setItem('moodHabit_Theme', t);
        localStorage.removeItem('moodHabit_CustomColor');
        updateUIColors(); 
        if(shouldClose) toggleThemeMenu();
    }

    function applyCustomTheme(hex, shouldClose = true) {
        document.documentElement.removeAttribute('data-theme');
        document.documentElement.style.setProperty('--main-pink', hex);
        document.documentElement.style.setProperty('--deep-pink', hex);
        const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        document.documentElement.style.setProperty('--light-pink', `rgba(${r},${g},${b}, 0.1)`);
        document.documentElement.style.setProperty('--analysis-bg', `linear-gradient(135deg, ${hex} 0%, rgba(${r},${g},${b}, 0.7) 100%)`);
        customColor = hex;
        localStorage.setItem('moodHabit_CustomColor', hex);
        updateUIColors(); 
        if(shouldClose) toggleThemeMenu();
    }

    function updateUIColors() {
        const color = getComputedStyle(document.documentElement).getPropertyValue('--main-pink').trim();
        if(mainChart) {
            mainChart.data.datasets[0].borderColor = color;
            mainChart.data.datasets[1].backgroundColor = color.includes('rgba') ? color : hexToRgba(color, 0.2);
            mainChart.update();
        }
        renderCalendar();
    }

    function hexToRgba(hex, alpha) {
        if(hex.startsWith('rgba')) return hex;
        const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r},${g},${b}, ${alpha})`;
    }

    function loadData() {
        const entry = store[selectedDateKey] || {mood:null, note:"", affirmation:"", habits:[]};
        document.getElementById('noteInput').value = entry.note || "";
        document.getElementById('affirmationInput').value = entry.affirmation || "";
        document.getElementById('affirmationDisplay').innerText = entry.affirmation ? `"${entry.affirmation}"` : "";
        habitNames.forEach((_, i) => { const chk = document.getElementById(`chk-${i}`); if(chk) chk.checked = !!(entry.habits && entry.habits[i]); });
    }

    function saveAll() {
        if(!store[selectedDateKey]) store[selectedDateKey] = {mood:null, habits:[]};
        store[selectedDateKey].note = document.getElementById('noteInput').value;
        store[selectedDateKey].affirmation = document.getElementById('affirmationInput').value;
        saveToLocal(); updateChartData(); renderCalendar(); loadData();
    }

    function renderCalendar() {
        const cal = document.getElementById('calendar'); cal.innerHTML = '';
        const y = dateContext.getFullYear(), m = dateContext.getMonth();
        document.getElementById('monthDisplay').innerText = `${y}.${m+1}`;
        const first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
        ['S','M','T','W','T','F','S'].forEach(l => { const d=document.createElement('div'); d.className='day-label'; d.innerText=l; cal.appendChild(d); });
        for(let i=0; i<first; i++) cal.appendChild(document.createElement('div'));
        for(let i=1; i<=last; i++) {
            const key = `${y}-${m+1}-${i}`, div = document.createElement('div');
            div.className = `day-cell ${key === selectedDateKey ? 'active' : ''} ${store[key]?.mood ? 'recorded' : ''}`;
            div.innerText = i; div.onclick = () => { selectedDateKey = key; loadData(); renderCalendar(); updateChartData(); };
            cal.appendChild(div);
        }
    }

    function renderEmojiPicker() {
        const grid = document.getElementById('emojiGrid'); grid.innerHTML = '';
        allEmojis.forEach(emoji => {
            const span = document.createElement('span'); span.innerText = emoji;
            span.onclick = () => { 
                if(pickingIndex !== -1) { 
                    emojiSet[pickingIndex] = emoji; 
                    saveToLocal(); 
                    mainChart.options.scales.y.ticks.callback = v => emojiSet[v] || '';
                    pickingIndex = -1; 
                    renderMoodButtons(); 
                    toggleEmojiMenu(); 
                    updateChartData(); 
                } 
            };
            grid.appendChild(span);
        });
    }

    function toggleEmojiMenu() { 
        const m = document.getElementById('emojiMenu'); 
        m.style.display = m.style.display === 'block' ? 'none' : 'block'; 
        if(m.style.display === 'block') { 
            document.querySelectorAll('.mood-btn').forEach((b, i) => b.onclick = () => { pickingIndex = 5-i; renderMoodButtons(); }); 
        } else { 
            pickingIndex = -1; renderMoodButtons(); 
        } 
    }

    function renderHabitList() {
        const list = document.getElementById('habitList'); list.innerHTML = '';
        habitNames.forEach((name, i) => {
            const item = document.createElement('div'); item.className = 'habit-item';
            item.innerHTML = `<input type="checkbox" onchange="updateHabit(${i})" id="chk-${i}" style="accent-color:var(--main-pink); width:18px; height:18px;"><input class="habit-name" value="${name}" onchange="editHabitName(${i}, this.value)"><span class="habit-del-btn" style="${isEditMode?'display:inline; margin-left:5px; cursor:pointer; color:#ff4d7d':'display:none'}" onclick="removeHabitItem(${i})">‚úï</span>`;
            list.appendChild(item);
        });
    }

    function toggleThemeMenu() { const m = document.getElementById('themeMenuPopup'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function toggleEditHabit() { isEditMode = !isEditMode; renderHabitList(); document.getElementById('addHabitBtn').style.display = isEditMode ? 'block' : 'none'; document.getElementById('editToggleBtn').innerText = isEditMode ? '‚úÖ' : '‚öôÔ∏è'; saveToLocal(); }
    function addHabitItem() { habitNames.push("ÏÉà ÏäµÍ¥Ä"); renderHabitList(); saveToLocal(); }
    function removeHabitItem(i) { habitNames.splice(i, 1); renderHabitList(); saveToLocal(); }
    function editHabitName(i, val) { habitNames[i] = val; saveToLocal(); }
    function updateHabit(i) { if(!store[selectedDateKey]) store[selectedDateKey] = {mood:null, habits:[]}; if(!store[selectedDateKey].habits) store[selectedDateKey].habits = []; store[selectedDateKey].habits[i] = document.getElementById(`chk-${i}`).checked; saveToLocal(); updateChartData(); }
    function switchView(v) { currentView = v; document.getElementById('btn-monthly').className = v === 'monthly' ? 'view-btn-large active' : 'view-btn-large'; document.getElementById('btn-weekly').className = v === 'weekly' ? 'view-btn-large active' : 'view-btn-large'; updateChartData(); }
    function changeMonth(diff) { dateContext.setMonth(dateContext.getMonth() + diff); renderCalendar(); updateChartData(); }
    function toggleHabitChart() { mainChart.data.datasets[1].hidden = !mainChart.data.datasets[1].hidden; mainChart.update(); }
    function closeYearlyView() { document.getElementById('yearly-overlay').style.display = 'none'; }
    function confirmDelete() { if(confirm("Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")) { delete store[selectedDateKey]; saveToLocal(); loadData(); renderCalendar(); updateChartData(); } }

    function openYearlyView() {
        document.getElementById('yearly-overlay').style.display = 'block';
        const container = document.getElementById('yearlyList'); container.innerHTML = '';
        const mainColor = getComputedStyle(document.documentElement).getPropertyValue('--main-pink').trim();
        for (let m = 1; m <= 12; m++) {
            const row = document.createElement('div'); row.className = 'month-row';
            row.innerHTML = `<div style="width:60px; font-weight:700; color:var(--deep-pink);">${m}Ïõî</div><div style="flex:1; height:80px;"><canvas id="yChart${m}"></canvas></div>`;
            container.appendChild(row);
            const daysCount = new Date(2026, m, 0).getDate();
            const daysLabels = Array.from({length: daysCount}, (_, i) => i + 1);
            new Chart(document.getElementById(`yChart${m}`).getContext('2d'), {
                type: 'line', data: { labels: daysLabels, datasets: [{ data: daysLabels.map(d => store[`2026-${m}-${d}`]?.mood || null), borderColor: mainColor, borderWidth: 2, pointRadius: 0, tension: 0.3, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false, min: 0, max: 6 } } },
                plugins: [{
                    beforeDraw: (chart) => {
                        const ctxY = chart.ctx; const yVal = chart.scales.y.getPixelForValue(3);
                        ctxY.save(); ctxY.setLineDash([5, 5]); ctxY.strokeStyle = 'rgba(150, 150, 150, 0.3)';
                        ctxY.beginPath(); ctxY.moveTo(chart.chartArea.left, yVal); ctxY.lineTo(chart.chartArea.right, yVal); ctxY.stroke(); ctxY.restore();
                    }
                }]
            });
        }
    }

    init();
</script>
</body>
</html>

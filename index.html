<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ Mood & Habit Butler ğŸŒ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        :root {
            --main-pink: #ff85a1; --light-pink: #fff0f3; --soft-bg: #fdf2f5; --deep-pink: #ff4d7d;
            --analysis-bg: linear-gradient(135deg, #ff9a9e 0%, #ff85a1 100%);
        }
        [data-theme="ocean"] {
            --main-pink: #48cae4; --light-pink: #e0f7fa; --soft-bg: #f0faff; --deep-pink: #0077b6;
            --analysis-bg: linear-gradient(135deg, #00b4d8 0%, #90e0ef 100%);
        }
        [data-theme="forest"] {
            --main-pink: #81b29a; --light-pink: #f2f4f3; --soft-bg: #f8f9f8; --deep-pink: #3d405b;
            --analysis-bg: linear-gradient(135deg, #81b29a 0%, #a8dadc 100%);
        }

        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--soft-bg); margin: 0; padding: 20px; display: flex; justify-content: center; color: #444; transition: all 0.3s; }
        .container { max-width: 1200px; width: 100%; display: grid; grid-template-columns: 360px 1fr; gap: 20px; }
        .card { background: #fff; border-radius: 25px; padding: 22px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); margin-bottom: 20px; position: relative; border: 1px solid rgba(0,0,0,0.02); }

        .graph-title-bar { background: white; border-radius: 20px; padding: 15px 25px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .title-group { display: flex; align-items: center; gap: 15px; }
        .title-group h2 { font-family: 'Dancing Script', cursive; font-size: 2.2rem; color: var(--deep-pink); margin: 0; }
        
        #themeMenuPopup { display: none; position: absolute; top: 45px; left: 100%; transform: translateX(10px); background: white; padding: 12px; border-radius: 18px; border: 2px solid var(--main-pink); z-index: 2000; flex-direction: column; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .theme-opt { padding: 6px 12px; border-radius: 10px; cursor: pointer; font-size: 0.85rem; font-weight: bold; white-space: nowrap; }
        .theme-opt:hover { background: var(--light-pink); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-label { font-size: 0.75rem; font-weight: 700; color: var(--main-pink); text-align: center; margin-bottom: 8px; }
        .day-cell { aspect-ratio: 1.1; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; font-size: 0.9rem; border: 1px solid var(--light-pink); position: relative; z-index: 1; background: #fff; }
        .day-cell.active { border: 2px solid var(--main-pink); font-weight: 700; color: var(--deep-pink); }
        .day-cell.recorded::after { content: 'â¤ï¸'; position: absolute; font-size: 1.8rem; opacity: 0.2; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1; }

        .mood-btn { font-size: 1.8rem; border: none; background: none; cursor: pointer; border-radius: 10px; }
        .mood-btn.picking { background: var(--light-pink); outline: 2px solid var(--main-pink); }

        #emojiMenu { display: none; position: absolute; right: 20px; top: 50px; background: white; border: 2px solid var(--main-pink); border-radius: 20px; padding: 15px; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 300px; }
        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 250px; overflow-y: auto; }

        .habit-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .habit-name { border: none; border-bottom: 1px dashed var(--main-pink); font-size: 0.95rem; width: 100%; outline: none; background: transparent; font-family: inherit; }
        
        .analysis-box { background: var(--analysis-bg); color: #fff; border-radius: 25px; padding: 25px; min-height: 150px; font-size: 1.05rem; line-height: 1.7; transition: 0.3s; }
        
        .input-field { width: 100%; border: 1px solid var(--light-pink); border-radius: 15px; padding: 12px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; outline: none; }
        .btn-pink { background: var(--main-pink); color: white; border: none; padding: 12px; border-radius: 15px; cursor: pointer; width: 100%; font-weight: 700; font-family: inherit; }
        .view-btn-large { flex: 1; padding: 12px; border-radius: 15px; border: 2.5px solid var(--main-pink); background: white; color: var(--main-pink); font-weight: 700; cursor: pointer; font-family: inherit; }
        .view-btn-large.active { background: var(--main-pink); color: white; }

        #cloud-tooltip { position: fixed; display: none; background: #fff; border: 2px solid var(--main-pink); padding: 12px 18px; border-radius: 25px; z-index: 3000; pointer-events: none; font-size: 0.9rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); color: #444; font-weight: 500; max-width: 200px; white-space: normal; transform: translate(-50%, -110%); }
        #cloud-tooltip::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); border-width: 10px 10px 0; border-style: solid; border-color: var(--main-pink) transparent; }

        #yearly-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--soft-bg); z-index: 9999; overflow-y: auto; padding: 40px; box-sizing: border-box; }
        .month-row { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; position: relative; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { grid-template-columns: 1fr; gap: 10px; }
            .graph-title-bar { flex-direction: column; gap: 15px; text-align: center; }
            .title-group h2 { font-size: 1.8rem; }
            .view-btn-large { width: 100% !important; }
            #yearly-overlay { padding: 20px; }
            #yearly-overlay h1 { font-size: 2.5rem !important; }
        }

        .lang-toggle { position: fixed; top: 20px; right: 20px; background: white; border: 2px solid var(--main-pink); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; color: var(--main-pink); z-index: 5000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .year-selector { padding: 10px 15px; border-radius: 12px; border: 2px solid var(--main-pink); font-family: inherit; font-weight: bold; color: var(--deep-pink); outline: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="lang-toggle" onclick="toggleLanguage()" id="langBtn">EN</div>

<div class="container">
    <div class="sidebar">
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                <button onclick="changeMonth(-1)" style="background:none; border:none; color:var(--main-pink); cursor:pointer;">â—€</button>
                <h3 id="monthDisplay" style="margin:0; color:var(--deep-pink);"></h3>
                <button onclick="changeMonth(1)" style="background:none; border:none; color:var(--main-pink); cursor:pointer;">â–¶</button>
            </div>
            <div class="calendar-grid" id="calendar"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="mood-box" id="moodBtnBox"></div>
                <div style="font-size:1.2rem; color:#ddd; cursor:pointer;" onclick="toggleEmojiMenu()">â‹®</div>
                <div id="emojiMenu">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>
            </div>
            <textarea id="noteInput" class="input-field" style="height: 80px; resize: none;" data-t-placeholder="notePlaceholder"></textarea>
            <input type="text" id="affirmationInput" class="input-field" data-t-placeholder="affirmationPlaceholder">
            <div style="display:flex; gap:10px;">
                <button class="btn-pink" onclick="saveAll()" data-t="saveBtn"></button>
                <button style="background:none; border:none; font-size:1.4rem; cursor:pointer;" onclick="confirmDelete()">ğŸ—‘ï¸</button>
            </div>
        </div>

        <div class="card" id="habitCard">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:18px;">
                <h3 style="margin:0; color:var(--deep-pink); font-weight:800;" data-t="habitTitle"></h3>
                <div style="display:flex; gap:12px; align-items: center;">
                    <span style="cursor:pointer; font-size:1.1rem;" onclick="toggleEditHabit()" id="editToggleBtn">âš™ï¸</span>
                    <span style="cursor:pointer; font-size:1.3rem;" onclick="toggleHabitChart()">ğŸ“ˆ</span>
                    <span style="cursor:pointer; font-size:1.3rem;" onclick="toggleHabitAnalysis()">ğŸ”</span>
                </div>
            </div>
            <div id="habitList"></div>
            <div id="addHabitBtn" onclick="addHabitItem()" style="display:none; text-align:center; color:var(--main-pink); cursor:pointer; border:1.5px dashed var(--main-pink); border-radius:12px; padding:8px; margin-top:10px; font-weight:bold;" data-t="addHabitBtn"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="graph-title-bar">
            <div class="title-group">
                <h2 data-t="mainTitle"></h2>
                <div style="position:relative;">
                    <button onclick="toggleThemeMenu()" style="background:none; border:none; cursor:pointer; font-size:1.4rem;">ğŸ¨</button>
                    <div id="themeMenuPopup">
                        <div class="theme-opt" onclick="applyTheme('pink')">ğŸŒ¸ Original Pink</div>
                        <div class="theme-opt" onclick="applyTheme('ocean')">ğŸŒŠ Ocean Calm</div>
                        <div class="theme-opt" onclick="applyTheme('forest')">ğŸŒ¿ Deep Forest</div>
                        <div style="border-top:1px solid #eee; margin:5px 0;"></div>
                        <div style="font-size:0.75rem; color:#999; margin-left:12px;" data-t="customColor"></div>
                        <input type="color" onchange="applyCustomTheme(this.value)" style="width:100%; height:30px; border:none; cursor:pointer; background:none;">
                    </div>
                </div>
            </div>
            <button class="view-btn-large" style="flex:none; width:180px; font-family:'Dancing Script';" onclick="openYearlyView()" data-t="yearlyJourneyBtn"></button>
        </div>

        <div class="card">
            <div style="display:flex; gap:10px; margin-bottom: 20px;">
                <button id="btn-monthly" class="view-btn-large active" onclick="switchView('monthly')" data-t="monthly"></button>
                <button id="btn-weekly" class="view-btn-large" onclick="switchView('weekly')" data-t="weekly"></button>
            </div>
            <div style="height:380px;">
                <canvas id="moodChart"></canvas>
            </div>
            <div id="affirmationDisplay" style="margin-top:20px; min-height:30px; text-align:center; color:var(--main-pink); font-style:italic; font-weight:600;"></div>
        </div>

        <div class="card analysis-box" id="analysisBox">
            <h4 style="margin:0 0 10px 0; opacity:0.9;" data-t="aiInsight"></h4>
            <div id="moodAnalysisText" data-t="analyzing"></div>
            <div id="habitAnalysisText" style="margin-top:10px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.3); display:none;"></div>
        </div>
    </div>
</div>

<div id="yearly-overlay">
    <div style="max-width: 900px; margin: 0 auto;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:30px;">
            <div style="display:flex; align-items: center; gap: 20px;">
                <h1 style="font-family:'Dancing Script'; color:var(--deep-pink); font-size:3.5rem; margin:0;" id="yearlyTitle"></h1>
                <select id="yearSelector" class="year-selector" onchange="updateYearlyView(this.value)"></select>
            </div>
            <button onclick="closeYearlyView()" class="btn-pink" style="width:100px;" data-t="closeBtn"></button>
        </div>
        <div id="yearlyList"></div>
    </div>
</div>

<div id="cloud-tooltip"></div>

<script>
    const i18n = {
        ko: {
            mainTitle: "Your Mood Butler",
            yearlyJourneyBtn: "Yearly Journey",
            monthly: "Monthly",
            weekly: "Weekly",
            aiInsight: "ğŸª„ AI Butler's Insight",
            analyzing: "ë¶„ì„ ì¤‘...",
            habitTitle: "Habit Tracker",
            addHabitBtn: "+ ìƒˆë¡œìš´ ëª©í‘œ ì¶”ê°€",
            notePlaceholder: "ì˜¤ëŠ˜ ì–´ë–¤ ì¼ì´ ìˆì—ˆë‚˜ìš”?",
            affirmationPlaceholder: "ë‚˜ë¥¼ í–¥í•œ í•œë§ˆë”” âœ¨",
            saveBtn: "ê¸°ë¡ ì™„ë£Œ âœ¨",
            closeBtn: "ë‹«ê¸°",
            customColor: "Custom Color",
            deleteConfirm: "ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?",
            moodSummary: "ê¸°ë¶„ ìš”ì•½",
            habitAnalysis: "ìŠµê´€ ë¶„ì„",
            moodVeryHappy: "ë§¤ìš° í™œê¸°ì°¬ ë‚ ë“¤ì´ì—ˆë„¤ìš”! ì§€ê¸ˆì²˜ëŸ¼ ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ìœ ì§€í•´ë´ìš”. âœ¨",
            moodCalm: "í‰ì˜¨í•˜ê³  ê· í˜• ì¡íŒ ë§ˆìŒì´ ëŠê»´ì§‘ë‹ˆë‹¤. ì°¸ ì˜í•˜ê³  ê³„ì„¸ìš”. ğŸŒ¿",
            moodLow: "ì¡°ê¸ˆ ê°€ë¼ì•‰ì€ ë‚ ë“¤ì´ ìˆì—ˆì§€ë§Œ, ê·¸ëŸ° ë‚  ë˜í•œ ê³¼ì •ì¼ ë¿ì…ë‹ˆë‹¤. ğŸ«‚",
            noData: "ì•„ì§ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
            habitBest: "ê¸°ë¡ëœ <b>{days}ì¼</b> ì¤‘ <b>'{habit}'</b>ì„(ë¥¼) ê°€ì¥ ì˜ ì‹¤ì²œí•˜ì…¨ë„¤ìš”! ì •ë§ ì¹­ì°¬í•´ìš”. ğŸ‘",
            habitEncourage: "<br><b>'{habit}'</b>ë„ í•œ ë²ˆë§Œ ë” ì‹œë„í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”? í˜ë‚´ì„¸ìš”!",
            monthSuffix: "ì›”",
            journeySuffix: "Journey"
        },
        en: {
            mainTitle: "Your Mood Butler",
            yearlyJourneyBtn: "Yearly Journey",
            monthly: "Monthly",
            weekly: "Weekly",
            aiInsight: "ğŸª„ AI Butler's Insight",
            analyzing: "Analyzing...",
            habitTitle: "Habit Tracker",
            addHabitBtn: "+ Add New Habit",
            notePlaceholder: "How was your day?",
            affirmationPlaceholder: "A word for yourself âœ¨",
            saveBtn: "Save âœ¨",
            closeBtn: "Close",
            customColor: "Custom Color",
            deleteConfirm: "Delete this record?",
            moodSummary: "Mood Summary",
            habitAnalysis: "Habit Analysis",
            moodVeryHappy: "You had very energetic days! Keep up this positive energy. âœ¨",
            moodCalm: "I feel a calm and balanced mind. You're doing great. ğŸŒ¿",
            moodLow: "There were some low days, but those are just part of the process. ğŸ«‚",
            noData: "No data recorded yet.",
            habitBest: "You practiced <b>'{habit}'</b> best out of <b>{days} days</b> recorded! Well done. ğŸ‘",
            habitEncourage: "<br>How about trying <b>'{habit}'</b> one more time? You can do it!",
            monthSuffix: "",
            journeySuffix: "Journey"
        }
    };

    let lang = localStorage.getItem('moodHabit_Lang') || 'ko';
    let currentView = 'monthly', dateContext = new Date();
    let selectedDateKey = formatDate(new Date());
    let pickingIndex = -1;
    let isEditMode = false;
    let isHabitAnalysisOpen = false;

    const store = JSON.parse(localStorage.getItem('moodHabitData_vFinal_V7')) || {};
    let habitNames = JSON.parse(localStorage.getItem('moodHabit_HabitNames')) || ["ë¬¼ 2L ë§ˆì‹œê¸°", "ìš´ë™ 30ë¶„", "ë¹„íƒ€ë¯¼ ì±™ê¸°ê¸°", "ë…ì„œ 10ë¶„"];
    let currentTheme = localStorage.getItem('moodHabit_Theme') || 'pink';
    let customColor = localStorage.getItem('moodHabit_CustomColor') || null;
    let emojiSet = JSON.parse(localStorage.getItem('moodHabit_EmojiSet')) || ["", "ğŸ˜­", "ğŸ˜”", "ğŸ™‚", "ğŸ˜Š", "ğŸ˜†"];

    const allEmojis = ["ğŸ˜­","ğŸ˜”","ğŸ™‚","ğŸ˜Š","ğŸ˜†","ğŸ¥°","ğŸ˜","ğŸ¥³","ğŸ¤©","ğŸ˜","ğŸ¥º","ğŸ¤”","ğŸ¤¨","ğŸ™„","ğŸ˜","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬","ğŸ¤¯","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ˜¥","ğŸ˜“","ğŸ¤—","ğŸ¤”","ğŸ¤­","ğŸ¤«","ğŸ¤¥","ğŸ˜¶","ğŸ˜","ğŸ˜‘","ğŸ˜¬","ğŸ™„","ğŸ˜¯","ğŸ˜¦","ğŸ˜§","ğŸ˜®","ğŸ˜²","ğŸ¥±","ğŸ˜´","ğŸ¤¤","ğŸ˜ª","ğŸ˜µ","ğŸ¤","ğŸ¥´","ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤‘","ğŸ¤ ","ğŸ˜ˆ","ğŸ‘¿","ğŸ‘¹","ğŸ‘º","ğŸ¤¡","ğŸ’©","ğŸ‘»","ğŸ’€","â˜ ï¸","ğŸ‘½","ğŸ‘¾","ğŸ¤–","ğŸƒ","ğŸ˜º","ğŸ˜¸","ğŸ˜¹","ğŸ˜»","ğŸ˜¼","ğŸ˜½","ğŸ™€","ğŸ˜¿","ğŸ˜¾","ğŸ¤²","ğŸ‘","ğŸ™Œ","ğŸ‘","ğŸ¤","ğŸ‘","ğŸ‘","ğŸ‘Š","âœŠ","ğŸ¤›","ğŸ¤œ","ğŸ¤","âœŒï¸","ğŸ¤Ÿ","ğŸ¤˜","ğŸ‘Œ","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ‘‡","â˜ï¸","âœ‹","ğŸ¤š","ğŸ–","ğŸ––","ğŸ‘‹","ğŸ¤™","ğŸ’ª","ğŸ¦¾","ğŸ–•","âœï¸","ğŸ™","ğŸ’","ğŸ’„","ğŸ’‹","ğŸ‘„","ğŸ‘…","ğŸ‘‚","ğŸ¦»","ğŸ‘ƒ","ğŸ‘£","ğŸ‘ï¸","ğŸ‘€","ğŸ§ ","ğŸ—£ï¸","ğŸ‘¤","ğŸ‘¥","ğŸ¤±","ğŸ¤°","ğŸ¤³","ğŸ’ƒ","ğŸ•º","ğŸ‘¯","ğŸ‘«","ğŸ‘­","ğŸ‘¬","ğŸ§¶","ğŸ§µ","ğŸ§¥","ğŸ¥¼","ğŸ¦º","ğŸ‘š","ğŸ‘•","ğŸ‘–","ğŸ§£","ğŸ§¤","ğŸ§¥","ğŸ§¦","ğŸ‘—","ğŸ‘˜","ğŸ‘™","ğŸ‘’","ğŸ©","ğŸ‘Ÿ","ğŸ‘","ğŸ‘¢","ğŸ‘¡","ğŸ‘ ","ğŸ‘œ","ğŸ‘›","ğŸ’","ğŸ’¼","ğŸ•¶ï¸","ğŸŒ‚","ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ½","ğŸ¸","ğŸµ"];

    let mainChart;
    const ctx = document.getElementById('moodChart').getContext('2d');
    const cloudTooltip = document.getElementById('cloud-tooltip');
    const affirmationDisplay = document.getElementById('affirmationDisplay');

    function init() {
        if (customColor) applyCustomTheme(customColor, false);
        else applyTheme(currentTheme, false);

        renderCalendar();
        renderMoodButtons();
        renderEmojiPicker();
        renderHabitList();
        initChart();
        loadData();
        updateLanguageUI();
        initYearSelector();
    }

    function toggleLanguage() {
        lang = lang === 'ko' ? 'en' : 'ko';
        localStorage.setItem('moodHabit_Lang', lang);
        updateLanguageUI();
        updateChartData();
        renderCalendar();
        renderHabitList();
    }

    function updateLanguageUI() {
        document.getElementById('langBtn').innerText = lang === 'ko' ? 'EN' : 'KO';
        document.querySelectorAll('[data-t]').forEach(el => {
            const key = el.getAttribute('data-t');
            el.innerHTML = i18n[lang][key];
        });
        document.querySelectorAll('[data-t-placeholder]').forEach(el => {
            const key = el.getAttribute('data-t-placeholder');
            el.placeholder = i18n[lang][key];
        });
    }

    function initYearSelector() {
        const selector = document.getElementById('yearSelector');
        const currentYear = new Date().getFullYear();
        for (let y = currentYear - 50; y <= currentYear + 50; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            if (y === currentYear) opt.selected = true;
            selector.appendChild(opt);
        }
    }

    function formatDate(date) { return `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`; }

    function runMoodAnalysisAuto() {
        const keys = mainChart.data.rawKeys;
        const viewName = currentView === 'monthly' ? (lang === 'ko' ? "ì´ë²ˆ ë‹¬" : "This Month") : (lang === 'ko' ? "ì´ë²ˆ ì£¼" : "This Week");
        let moodSum = 0, moodCount = 0;
        keys.forEach(k => { if(store[k]?.mood) { moodSum += store[k].mood; moodCount++; } });

        let analysis = `<b>[${viewName} ${i18n[lang].moodSummary}]</b><br>`;
        if(moodCount > 0) {
            const avg = moodSum / moodCount;
            if(avg >= 4) analysis += i18n[lang].moodVeryHappy;
            else if(avg >= 2.5) analysis += i18n[lang].moodCalm;
            else analysis += i18n[lang].moodLow;
        } else { analysis += i18n[lang].noData; }
        document.getElementById('moodAnalysisText').innerHTML = analysis;
        if(isHabitAnalysisOpen) runHabitAnalysisOnly();
    }

    function toggleHabitAnalysis() {
        isHabitAnalysisOpen = !isHabitAnalysisOpen;
        const hBox = document.getElementById('habitAnalysisText');
        if(isHabitAnalysisOpen) {
            hBox.style.display = 'block';
            runHabitAnalysisOnly();
        } else {
            hBox.style.display = 'none';
        }
    }

    function runHabitAnalysisOnly() {
        const keys = mainChart.data.rawKeys;
        const viewName = currentView === 'monthly' ? (lang === 'ko' ? "ì´ë²ˆ ë‹¬" : "This Month") : (lang === 'ko' ? "ì´ë²ˆ ì£¼" : "This Week");
        let habitCounts = habitNames.map(() => 0);
        let activeDays = 0;

        keys.forEach(k => {
            if(store[k]?.habits && store[k].habits.some(h => h === true)) {
                activeDays++;
                store[k].habits.forEach((h, idx) => { if(h) habitCounts[idx]++; });
            }
        });

        const hBox = document.getElementById('habitAnalysisText');
        if(activeDays > 0) {
            let maxVal = Math.max(...habitCounts);
            let minVal = Math.min(...habitCounts);
            let bestIdx = habitCounts.indexOf(maxVal);
            let worstIdx = habitCounts.indexOf(minVal);

            let text = `<b>[${viewName} ${i18n[lang].habitAnalysis}]</b><br>`;
            text += i18n[lang].habitBest.replace('{days}', activeDays).replace('{habit}', habitNames[bestIdx]);
            if(maxVal !== minVal) { text += i18n[lang].habitEncourage.replace('{habit}', habitNames[worstIdx]); }
            hBox.innerHTML = text;
        } else { hBox.innerHTML = `<b>[${viewName} ${i18n[lang].habitAnalysis}]</b><br>${i18n[lang].noData}`; }
    }

    function initChart() {
        mainChart = new Chart(ctx, {
            data: {
                labels: [],
                datasets: [
                    { type: 'line', data: [], borderColor: getComputedStyle(document.documentElement).getPropertyValue('--main-pink'), borderWidth: 5, tension: 0.3, pointRadius: 7, pointBackgroundColor: '#fff', hoverPointRadius: 10, spanGaps: true },
                    { type: 'bar', data: [], backgroundColor: hexToRgba(getComputedStyle(document.documentElement).getPropertyValue('--main-pink'), 0.2), hidden: true, borderRadius: 5 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: {
                    y: { min: 0, max: 6, ticks: { font: { size: 22 }, callback: v => emojiSet[v] || '' } },
                    x: { grid: { display: false } }
                },
                onHover: (e, el) => {
                    if (el.length > 0) {
                        const index = el[0].index;
                        const key = mainChart.data.rawKeys[index];
                        const entry = store[key];
                        if(entry?.note) {
                            cloudTooltip.innerText = entry.note;
                            cloudTooltip.style.display = 'block';
                            cloudTooltip.style.left = e.native.clientX + 'px';
                            cloudTooltip.style.top = e.native.clientY + 'px';
                        } else { cloudTooltip.style.display = 'none'; }
                        if(entry?.affirmation) { affirmationDisplay.innerText = `"${entry.affirmation}"`; }
                        else { affirmationDisplay.innerText = ""; }
                        return;
                    }
                    cloudTooltip.style.display = 'none';
                    const currentEntry = store[selectedDateKey];
                    affirmationDisplay.innerText = currentEntry?.affirmation ? `"${currentEntry.affirmation}"` : "";
                }
            }
        });
        updateChartData();
    }

    function updateChartData() {
        const y = dateContext.getFullYear(), m = dateContext.getMonth() + 1;
        let labels = [], rawKeys = [];
        if (currentView === 'monthly') {
            const last = new Date(y, m, 0).getDate();
            for(let i=1; i<=last; i++) { labels.push(i); rawKeys.push(`${y}-${m}-${i}`); }
        } else {
            const sel = new Date(selectedDateKey); const sun = new Date(sel.setDate(sel.getDate() - sel.getDay()));
            for(let i=0; i<7; i++) { const d = new Date(sun); d.setDate(sun.getDate() + i); labels.push(d.getDate()); rawKeys.push(`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`); }
        }
        mainChart.data.labels = labels; mainChart.data.rawKeys = rawKeys;
        mainChart.data.datasets[0].data = rawKeys.map(k => store[k]?.mood || null);
        mainChart.data.datasets[1].data = rawKeys.map(k => (store[k]?.habits || []).filter(h => h).length);
        mainChart.update();
        runMoodAnalysisAuto();
    }

    function triggerPinkConfetti() {
        const color = getComputedStyle(document.documentElement).getPropertyValue('--main-pink').trim();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: [color, '#ffb3c1', '#ffffff'] });
    }

    function renderMoodButtons() {
        const box = document.getElementById('moodBtnBox'); box.innerHTML = '';
        [5, 4, 3, 2, 1].forEach(v => {
            const btn = document.createElement('button'); btn.className = `mood-btn ${pickingIndex === v ? 'picking' : ''}`;
            btn.innerText = emojiSet[v];
            btn.onclick = () => {
                if (pickingIndex !== -1) return;
                if(!store[selectedDateKey]) store[selectedDateKey] = {mood:null, habits:[]};
                store[selectedDateKey].mood = v;
                if(v === 5) triggerPinkConfetti();
                saveToLocal(); updateChartData(); renderCalendar();
            };
            box.appendChild(btn);
        });
    }

    function saveToLocal() { 
        localStorage.setItem('moodHabitData_vFinal_V7', JSON.stringify(store)); 
        localStorage.setItem('moodHabit_HabitNames', JSON.stringify(habitNames));
        localStorage.setItem('moodHabit_EmojiSet', JSON.stringify(emojiSet));
    }

    function applyTheme(t, shouldClose = true) {
        document.documentElement.style = ""; document.documentElement.removeAttribute('data-theme');
        if(t !== 'pink') document.documentElement.setAttribute('data-theme', t);
        currentTheme = t; customColor = null;
        localStorage.setItem('moodHabit_Theme', t);
        localStorage.removeItem('moodHabit_CustomColor');
        updateUIColors(); 
        if(shouldClose) toggleThemeMenu();
    }

    function applyCustomTheme(hex, shouldClose = true) {
        document.documentElement.removeAttribute('data-theme');
        document.documentElement.style.setProperty('--main-pink', hex);
        document.documentElement.style.setProperty('--deep-pink', hex);
        const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        document.documentElement.style.setProperty('--light-pink', `rgba(${r},${g},${b}, 0.1)`);
        document.documentElement.style.setProperty('--analysis-bg', `linear-gradient(135deg, ${hex} 0%, rgba(${r},${g},${b}, 0.7) 100%)`);
        customColor = hex;
        localStorage.setItem('moodHabit_CustomColor', hex);
        updateUIColors(); 
        if(shouldClose) toggleThemeMenu();
    }

    function updateUIColors() {
        const color = getComputedStyle(document.documentElement).getPropertyValue('--main-pink').trim();
        if(mainChart) {
            mainChart.data.datasets[0].borderColor = color;
            mainChart.data.datasets[1].backgroundColor = color.includes('rgba') ? color : hexToRgba(color, 0.2);
            mainChart.update();
        }
        renderCalendar();
    }

    function hexToRgba(hex, alpha) {
        if(hex.startsWith('rgba')) return hex;
        const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r},${g},${b}, ${alpha})`;
    }

    function loadData() {
        const entry = store[selectedDateKey] || {mood:null, note:"", affirmation:"", habits:[]};
        document.getElementById('noteInput').value = entry.note || "";
        document.getElementById('affirmationInput').value = entry.affirmation || "";
        document.getElementById('affirmationDisplay').innerText = entry.affirmation ? `"${entry.affirmation}"` : "";
        habitNames.forEach((_, i) => { const chk = document.getElementById(`chk-${i}`); if(chk) chk.checked = !!(entry.habits && entry.habits[i]); });
    }

    function saveAll() {
        if(!store[selectedDateKey]) store[selectedDateKey] = {mood:null, habits:[]};
        store[selectedDateKey].note = document.getElementById('noteInput').value;
        store[selectedDateKey].affirmation = document.getElementById('affirmationInput').value;
        saveToLocal(); updateChartData(); renderCalendar(); loadData();
    }

    function renderCalendar() {
        const cal = document.getElementById('calendar'); cal.innerHTML = '';
        const y = dateContext.getFullYear(), m = dateContext.getMonth();
        document.getElementById('monthDisplay').innerText = `${y}.${m+1}`;
        const first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
        const labels = lang === 'ko' ? ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '] : ['S','M','T','W','T','F','S'];
        labels.forEach(l => { const d=document.createElement('div'); d.className='day-label'; d.innerText=l; cal.appendChild(d); });
        for(let i=0; i<first; i++) cal.appendChild(document.createElement('div'));
        for(let i=1; i<=last; i++) {
            const key = `${y}-${m+1}-${i}`, div = document.createElement('div');
            div.className = `day-cell ${key === selectedDateKey ? 'active' : ''} ${store[key]?.mood ? 'recorded' : ''}`;
            div.innerText = i; div.onclick = () => { selectedDateKey = key; loadData(); renderCalendar(); updateChartData(); };
            cal.appendChild(div);
        }
    }

    function renderEmojiPicker() {
        const grid = document.getElementById('emojiGrid'); grid.innerHTML = '';
        allEmojis.forEach(emoji => {
            const span = document.createElement('span'); span.innerText = emoji;
            span.onclick = () => { 
                if(pickingIndex !== -1) { 
                    emojiSet[pickingIndex] = emoji; 
                    saveToLocal(); 
                    mainChart.options.scales.y.ticks.callback = v => emojiSet[v] || '';
                    pickingIndex = -1; 
                    renderMoodButtons(); 
                    toggleEmojiMenu(); 
                    updateChartData(); 
                } 
            };
            grid.appendChild(span);
        });
    }

    function toggleEmojiMenu() { 
        const m = document.getElementById('emojiMenu'); 
        m.style.display = m.style.display === 'block' ? 'none' : 'block'; 
        if(m.style.display === 'block') { 
            document.querySelectorAll('.mood-btn').forEach((b, i) => b.onclick = () => { pickingIndex = 5-i; renderMoodButtons(); }); 
        } else { 
            pickingIndex = -1; renderMoodButtons(); 
        } 
    }

    function renderHabitList() {
        const list = document.getElementById('habitList'); list.innerHTML = '';
        habitNames.forEach((name, i) => {
            const item = document.createElement('div'); item.className = 'habit-item';
            item.innerHTML = `<input type="checkbox" onchange="updateHabit(${i})" id="chk-${i}" style="accent-color:var(--main-pink); width:18px; height:18px;"><input class="habit-name" value="${name}" onchange="editHabitName(${i}, this.value)"><span class="habit-del-btn" style="${isEditMode?'display:inline; margin-left:5px; cursor:pointer; color:#ff4d7d':'display:none'}" onclick="removeHabitItem(${i})">âœ•</span>`;
            list.appendChild(item);
        });
    }

    function toggleThemeMenu() { const m = document.getElementById('themeMenuPopup'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function toggleEditHabit() { isEditMode = !isEditMode; renderHabitList(); document.getElementById('addHabitBtn').style.display = isEditMode ? 'block' : 'none'; document.getElementById('editToggleBtn').innerText = isEditMode ? 'âœ…' : 'âš™ï¸'; saveToLocal(); }
    function addHabitItem() { habitNames.push(lang === 'ko' ? "ìƒˆ ìŠµê´€" : "New Habit"); renderHabitList(); saveToLocal(); }
    function removeHabitItem(i) { habitNames.splice(i, 1); renderHabitList(); saveToLocal(); }
    function editHabitName(i, val) { habitNames[i] = val; saveToLocal(); }
    function updateHabit(i) { if(!store[selectedDateKey]) store[selectedDateKey] = {mood:null, habits:[]}; if(!store[selectedDateKey].habits) store[selectedDateKey].habits = []; store[selectedDateKey].habits[i] = document.getElementById(`chk-${i}`).checked; saveToLocal(); updateChartData(); }
    function switchView(v) { currentView = v; document.getElementById('btn-monthly').className = v === 'monthly' ? 'view-btn-large active' : 'view-btn-large'; document.getElementById('btn-weekly').className = v === 'weekly' ? 'view-btn-large active' : 'view-btn-large'; updateChartData(); }
    function changeMonth(diff) { dateContext.setMonth(dateContext.getMonth() + diff); renderCalendar(); updateChartData(); }
    function toggleHabitChart() { mainChart.data.datasets[1].hidden = !mainChart.data.datasets[1].hidden; mainChart.update(); }
    function closeYearlyView() { document.getElementById('yearly-overlay').style.display = 'none'; }
    function confirmDelete() { if(confirm(i18n[lang].deleteConfirm)) { delete store[selectedDateKey]; saveToLocal(); loadData(); renderCalendar(); updateChartData(); } }

    function openYearlyView() {
        document.getElementById('yearly-overlay').style.display = 'block';
        const currentYear = new Date().getFullYear();
        document.getElementById('yearSelector').value = currentYear;
        updateYearlyView(currentYear);
    }

    function updateYearlyView(year) {
        const container = document.getElementById('yearlyList'); container.innerHTML = '';
        document.getElementById('yearlyTitle').innerText = `${year} ${i18n[lang].journeySuffix}`;
        const mainColor = getComputedStyle(document.documentElement).getPropertyValue('--main-pink').trim();
        for (let m = 1; m <= 12; m++) {
            const row = document.createElement('div'); row.className = 'month-row';
            row.innerHTML = `<div style="width:60px; font-weight:700; color:var(--deep-pink);">${m}${i18n[lang].monthSuffix}</div><div style="flex:1; height:80px;"><canvas id="yChart${m}"></canvas></div>`;
            container.appendChild(row);
            const daysCount = new Date(year, m, 0).getDate();
            const daysLabels = Array.from({length: daysCount}, (_, i) => i + 1);
            new Chart(document.getElementById(`yChart${m}`).getContext('2d'), {
                type: 'line', data: { labels: daysLabels, datasets: [{ data: daysLabels.map(d => store[`${year}-${m}-${d}`]?.mood || null), borderColor: mainColor, borderWidth: 2, pointRadius: 0, tension: 0.3, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false, min: 0, max: 6 } } },
                plugins: [{
                    beforeDraw: (chart) => {
                        const ctxY = chart.ctx; const yVal = chart.scales.y.getPixelForValue(3);
                        ctxY.save(); ctxY.setLineDash([5, 5]); ctxY.strokeStyle = 'rgba(150, 150, 150, 0.3)';
                        ctxY.beginPath(); ctxY.moveTo(chart.chartArea.left, yVal); ctxY.lineTo(chart.chartArea.right, yVal); ctxY.stroke(); ctxY.restore();
                    }
                }]
            });
        }
    }

    init();
</script>
</body>
</html>
